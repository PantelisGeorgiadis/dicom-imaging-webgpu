!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).dicomImagingWebGpu={})}(this,function(e){"use strict";function t(e,t,r,a,n,i,o){try{var s=e[i](o),f=s.value}catch(e){return void r(e)}s.done?t(f):Promise.resolve(f).then(a,n)}function r(e){return function(){var r=this,a=arguments;return new Promise(function(n,i){var o=e.apply(r,a);function s(e){t(o,n,i,s,f,"next",e)}function f(e){t(o,n,i,s,f,"throw",e)}s(void 0)})}}function a(e,t,r){return t=f(t),function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,d()?Reflect.construct(t,r||[],f(e).constructor):t.apply(e,r))}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,p(a.key),a)}}function o(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e,t,r){return(t=p(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}function d(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(d=function(){return!!e})()}function l(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */
var e,t,r="function"==typeof Symbol?Symbol:{},a=r.iterator||"@@iterator",n=r.toStringTag||"@@toStringTag";function i(r,a,n,i){var f=a&&a.prototype instanceof s?a:s,d=Object.create(f.prototype);return u(d,"_invoke",function(r,a,n){var i,s,f,d=0,l=n||[],u=!1,c={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,r){return i=t,s=0,f=e,c.n=r,o}};function p(r,a){for(s=r,f=a,t=0;!u&&d&&!n&&t<l.length;t++){var n,i=l[t],p=c.p,m=i[2];r>3?(n=m===a)&&(f=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=p&&((n=r<2&&p<i[1])?(s=0,c.v=a,c.n=i[1]):p<m&&(n=r<3||i[0]>a||a>m)&&(i[4]=r,i[5]=a,c.n=m,s=0))}if(n||r>1)return o;throw u=!0,a}return function(n,l,m){if(d>1)throw TypeError("Generator is already running");for(u&&1===l&&p(l,m),s=l,f=m;(t=s<2?e:f)||!u;){i||(s?s<3?(s>1&&(c.n=-1),p(s,f)):c.n=f:c.v=f);try{if(d=2,i){if(s||(n="next"),t=i[n]){if(!(t=t.call(i,f)))throw TypeError("iterator result is not an object");if(!t.done)return t;f=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(f=TypeError("The iterator does not provide a '"+n+"' method"),s=1);i=e}else if((t=(u=c.n<0)?f:r.call(a,c))!==o)break}catch(t){i=e,s=1,f=t}finally{d=1}}return{value:t,done:u}}}(r,n,i),!0),d}var o={};function s(){}function f(){}function d(){}t=Object.getPrototypeOf;var c=[][a]?t(t([][a]())):(u(t={},a,function(){return this}),t),p=d.prototype=s.prototype=Object.create(c);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,u(e,n,"GeneratorFunction")),e.prototype=Object.create(p),e}return f.prototype=d,u(p,"constructor",d),u(d,"constructor",f),f.displayName="GeneratorFunction",u(d,n,"GeneratorFunction"),u(p),u(p,n,"Generator"),u(p,a,function(){return this}),u(p,"toString",function(){return"[object Generator]"}),(l=function(){return{w:i,m:m}})()}function u(e,t,r,a){var n=Object.defineProperty;try{n({},"",{})}catch(e){n=0}u=function(e,t,r,a){function i(t,r){u(e,t,function(e){return this._invoke(t,r,e)})}t?n?n(e,t,{value:r,enumerable:!a,configurable:!a,writable:!a}):e[t]=r:(i("next",0),i("throw",1),i("return",2))},u(e,t,r,a)}function c(e,t){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},c(e,t)}function p(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var a=r.call(e,t);if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function m(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function h(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if("function"==typeof t){var r=function e(){var r=!1;try{r=this instanceof e}catch{}return r?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var a=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,a.get?a:{enumerable:!0,get:function(){return e[t]}})}),r}var g,y={exports:{}},b=h(Object.freeze({__proto__:null,default:{}}));var v=(g||(g=1,function(e){e.exports=function(e){return r=[function(t,r){t.exports=e},function(e,t,r){r.r(t),r.d(t,"isStringVr",function(){return n}),r.d(t,"isPrivateTag",function(){return i}),r.d(t,"parsePN",function(){return o}),r.d(t,"parseTM",function(){return s}),r.d(t,"parseDA",function(){return d}),r.d(t,"explicitElementToString",function(){return l}),r.d(t,"explicitDataSetToJS",function(){return u}),r.d(t,"createJPEGBasicOffsetTable",function(){return m}),r.d(t,"parseDicomDataSetExplicit",function(){return T}),r.d(t,"parseDicomDataSetImplicit",function(){return k}),r.d(t,"readFixedString",function(){return b}),r.d(t,"alloc",function(){return q}),r.d(t,"version",function(){return _}),r.d(t,"bigEndianByteArrayParser",function(){return M}),r.d(t,"ByteStream",function(){return L}),r.d(t,"sharedCopy",function(){return G}),r.d(t,"DataSet",function(){return P}),r.d(t,"findAndSetUNElementLength",function(){return y}),r.d(t,"findEndOfEncapsulatedElement",function(){return g}),r.d(t,"findItemDelimitationItemAndSetElementLength",function(){return x}),r.d(t,"littleEndianByteArrayParser",function(){return C}),r.d(t,"parseDicom",function(){return z}),r.d(t,"readDicomElementExplicit",function(){return B}),r.d(t,"readDicomElementImplicit",function(){return A}),r.d(t,"readEncapsulatedImageFrame",function(){return Y}),r.d(t,"readEncapsulatedPixelData",function(){return $}),r.d(t,"readEncapsulatedPixelDataFromFragments",function(){return J}),r.d(t,"readPart10Header",function(){return N}),r.d(t,"readSequenceItemsExplicit",function(){return U}),r.d(t,"readSequenceItemsImplicit",function(){return D}),r.d(t,"readSequenceItem",function(){return S}),r.d(t,"readTag",function(){return h});var a={AE:!0,AS:!0,AT:!1,CS:!0,DA:!0,DS:!0,DT:!0,FL:!1,FD:!1,IS:!0,LO:!0,LT:!0,OB:!1,OD:!1,OF:!1,OW:!1,PN:!0,SH:!0,SL:!1,SQ:!1,SS:!1,ST:!0,TM:!0,UI:!0,UL:!1,UN:void 0,UR:!0,US:!1,UT:!0},n=function(e){return a[e]},i=function(e){if(e=parseInt(e[4],16),isNaN(e))throw"dicomParser.isPrivateTag: cannot parse last character of group";return e%2==1},o=function(e){if(void 0!==e)return{familyName:(e=e.split("^"))[0],givenName:e[1],middleName:e[2],prefix:e[3],suffix:e[4]}};function s(e,t){if(2<=e.length){var r=parseInt(e.substring(0,2),10),a=4<=e.length?parseInt(e.substring(2,4),10):void 0,n=6<=e.length?parseInt(e.substring(4,6),10):void 0,i=(i=8<=e.length?e.substring(7,13):void 0)?parseInt(i,10)*Math.pow(10,6-i.length):void 0;if(t&&(isNaN(r)||void 0!==a&&isNaN(a)||void 0!==n&&isNaN(n)||void 0!==i&&isNaN(i)||r<0||23<r||a&&(a<0||59<a)||n&&(n<0||59<n)||i&&(i<0||999999<i)))throw"invalid TM '".concat(e,"'");return{hours:r,minutes:a,seconds:n,fractionalSeconds:i}}if(t)throw"invalid TM '".concat(e,"'")}function f(e,t,r){return!isNaN(r)&&0<t&&t<=12&&0<e&&e<=function(e,t){switch(e){case 2:return t%4==0&&t%100||t%400==0?29:28;case 9:case 4:case 6:case 11:return 30;default:return 31}}(t,r)}function d(e,t){if(e&&8===e.length){var r=parseInt(e.substring(0,4),10),a=parseInt(e.substring(4,6),10),n=parseInt(e.substring(6,8),10);if(t&&!0!==f(n,a,r))throw"invalid DA '".concat(e,"'");return{year:r,month:a,day:n}}if(t)throw"invalid DA '".concat(e,"'")}function l(e,t){if(void 0===e||void 0===t)throw"dicomParser.explicitElementToString: missing required parameters";if(void 0===t.vr)throw"dicomParser.explicitElementToString: cannot convert implicit element to string";var r,a=t.vr,i=t.tag;function o(t,r){for(var a="",n=0;n<t;n++)0!==n&&(a+="/"),a+=r.call(e,i,n).toString();return a}if(!0===n(a))r=e.string(i);else{if("AT"===a){var s=e.uint32(i);return void 0===s?void 0:"x".concat((s=s<0?4294967295+s+1:s).toString(16).toUpperCase())}"US"===a?r=o(t.length/2,e.uint16):"SS"===a?r=o(t.length/2,e.int16):"UL"===a?r=o(t.length/4,e.uint32):"SL"===a?r=o(t.length/4,e.int32):"FD"===a?r=o(t.length/8,e.double):"FL"===a&&(r=o(t.length/4,e.float))}return r}function u(e,t){if(void 0===e)throw"dicomParser.explicitDataSetToJS: missing required parameter dataSet";t=t||{omitPrivateAttibutes:!0,maxElementLength:128};var r,a={};for(r in e.elements){var n=e.elements[r];if(!0!==t.omitPrivateAttibutes||!i(r))if(n.items){for(var o=[],s=0;s<n.items.length;s++)o.push(u(n.items[s].dataSet,t));a[r]=o}else{var f=void 0;n.length<t.maxElementLength&&(f=l(e,n)),a[r]=void 0!==f?f:{dataOffset:n.dataOffset,length:n.length}}}return a}function c(e,t){return 255===e.byteArray[t]&&217===e.byteArray[t+1]}function p(e,t,r){for(var a,n,i=r;i<t.fragments.length;i++)if(n=i,c(a=e,(n=t.fragments[n]).position+n.length-2)||c(a,n.position+n.length-3))return i}function m(e,t,r){if(void 0===e)throw"dicomParser.createJPEGBasicOffsetTable: missing required parameter dataSet";if(void 0===t)throw"dicomParser.createJPEGBasicOffsetTable: missing required parameter pixelDataElement";if("x7fe00010"!==t.tag)throw"dicomParser.createJPEGBasicOffsetTable: parameter 'pixelDataElement' refers to non pixel data tag (expected tag = x7fe00010'";if(!0!==t.encapsulatedPixelData)throw"dicomParser.createJPEGBasicOffsetTable: parameter 'pixelDataElement' refers to pixel data element that does not have encapsulated pixel data";if(!0!==t.hadUndefinedLength)throw"dicomParser.createJPEGBasicOffsetTable: parameter 'pixelDataElement' refers to pixel data element that does not have encapsulated pixel data";if(void 0===t.basicOffsetTable)throw"dicomParser.createJPEGBasicOffsetTable: parameter 'pixelDataElement' refers to pixel data element that does not have encapsulated pixel data";if(void 0===t.fragments)throw"dicomParser.createJPEGBasicOffsetTable: parameter 'pixelDataElement' refers to pixel data element that does not have encapsulated pixel data";if(t.fragments.length<=0)throw"dicomParser.createJPEGBasicOffsetTable: parameter 'pixelDataElement' refers to pixel data element that does not have encapsulated pixel data";if(r&&r.length<=0)throw"dicomParser.createJPEGBasicOffsetTable: parameter 'fragments' must not be zero length";r=r||t.fragments;for(var a=[],n=0;;){a.push(t.fragments[n].offset);var i=p(e,t,n);if(void 0===i||i===t.fragments.length-1)return a;n=i+1}}function h(e){if(void 0===e)throw"dicomParser.readTag: missing required parameter 'byteStream'";var t=256*e.readUint16()*256;return e=e.readUint16(),"x".concat("00000000".concat((t+e).toString(16)).substr(-8))}function g(e,t,r){if(void 0===e)throw"dicomParser.findEndOfEncapsulatedElement: missing required parameter 'byteStream'";if(void 0===t)throw"dicomParser.findEndOfEncapsulatedElement: missing required parameter 'element'";if(t.encapsulatedPixelData=!0,t.basicOffsetTable=[],t.fragments=[],"xfffee000"!==h(e))throw"dicomParser.findEndOfEncapsulatedElement: basic offset table not found";for(var a=e.readUint32()/4,n=0;n<a;n++){var i=e.readUint32();t.basicOffsetTable.push(i)}for(var o=e.position;e.position<e.byteArray.length;){var s=h(e),f=e.readUint32();if("xfffee0dd"===s)return e.seek(f),void(t.length=e.position-t.dataOffset);if("xfffee000"!==s)return r&&r.push("unexpected tag ".concat(s," while searching for end of pixel data element with undefined length")),f>e.byteArray.length-e.position&&(f=e.byteArray.length-e.position),t.fragments.push({offset:e.position-o-8,position:e.position,length:f}),e.seek(f),void(t.length=e.position-t.dataOffset);t.fragments.push({offset:e.position-o-8,position:e.position,length:f}),e.seek(f)}r&&r.push("pixel data element ".concat(t.tag," missing sequence delimiter tag xfffee0dd"))}function y(e,t){if(void 0===e)throw"dicomParser.findAndSetUNElementLength: missing required parameter 'byteStream'";for(var r=e.byteArray.length-8;e.position<=r;)if(65534===e.readUint16()&&57565===e.readUint16())return 0!==e.readUint32()&&e.warnings("encountered non zero length following item delimiter at position ".concat(e.position-4," while reading element of undefined length with tag ").concat(t.tag)),void(t.length=e.position-t.dataOffset);t.length=e.byteArray.length-t.dataOffset,e.seek(e.byteArray.length-e.position)}function b(e,t,r){if(r<0)throw"dicomParser.readFixedString - length cannot be less than 0";if(t+r>e.length)throw"dicomParser.readFixedString: attempt to read past end of buffer";for(var a,n="",i=0;i<r;i++){if(0===(a=e[t+i]))return t+=r,n;n+=String.fromCharCode(a)}return n}function v(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function w(e,t){return void 0!==e.parser?e.parser:t}var P=function(){function e(t,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.byteArrayParser=t,this.byteArray=r,this.elements=a}var t,r;return t=e,(r=[{key:"uint16",value:function(e,t){if(t=void 0!==t?t:0,(e=this.elements[e])&&0!==e.length)return w(e,this.byteArrayParser).readUint16(this.byteArray,e.dataOffset+2*t)}},{key:"int16",value:function(e,t){if(t=void 0!==t?t:0,(e=this.elements[e])&&0!==e.length)return w(e,this.byteArrayParser).readInt16(this.byteArray,e.dataOffset+2*t)}},{key:"uint32",value:function(e,t){if(t=void 0!==t?t:0,(e=this.elements[e])&&0!==e.length)return w(e,this.byteArrayParser).readUint32(this.byteArray,e.dataOffset+4*t)}},{key:"int32",value:function(e,t){if(t=void 0!==t?t:0,(e=this.elements[e])&&0!==e.length)return w(e,this.byteArrayParser).readInt32(this.byteArray,e.dataOffset+4*t)}},{key:"float",value:function(e,t){if(t=void 0!==t?t:0,(e=this.elements[e])&&0!==e.length)return w(e,this.byteArrayParser).readFloat(this.byteArray,e.dataOffset+4*t)}},{key:"double",value:function(e,t){if(t=void 0!==t?t:0,(e=this.elements[e])&&0!==e.length)return w(e,this.byteArrayParser).readDouble(this.byteArray,e.dataOffset+8*t)}},{key:"numStringValues",value:function(e){if((e=this.elements[e])&&0<e.length)return null===(e=b(this.byteArray,e.dataOffset,e.length).match(/\\/g))?1:e.length+1}},{key:"string",value:function(e,t){return(e=this.elements[e])&&e.Value?e.Value:e&&0<e.length?(e=b(this.byteArray,e.dataOffset,e.length),0<=t?e.split("\\")[t].trim():e.trim()):void 0}},{key:"text",value:function(e,t){if((e=this.elements[e])&&0<e.length)return e=b(this.byteArray,e.dataOffset,e.length),0<=t?e.split("\\")[t].replace(/ +$/,""):e.replace(/ +$/,"")}},{key:"floatString",value:function(e,t){var r=this.elements[e];if(r&&0<r.length&&void 0!==(t=this.string(e,t=void 0!==t?t:0)))return parseFloat(t)}},{key:"intString",value:function(e,t){var r=this.elements[e];if(r&&0<r.length&&void 0!==(t=this.string(e,t=void 0!==t?t:0)))return parseInt(t)}},{key:"attributeTag",value:function(e){if((r=this.elements[e])&&4===r.length){var t=w(r,this.byteArrayParser).readUint16,r=(e=this.byteArray,r.dataOffset);return"x".concat("00000000".concat((256*t(e,r)*256+t(e,r+2)).toString(16)).substr(-8))}}}])&&v(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function x(e,t){if(void 0===e)throw"dicomParser.readDicomElementImplicit: missing required parameter 'byteStream'";for(var r=e.byteArray.length-8;e.position<=r;)if(65534===e.readUint16()&&57357===e.readUint16())return 0!==e.readUint32()&&e.warnings("encountered non zero length following item delimiter at position ".concat(e.position-4," while reading element of undefined length with tag ").concat(t.tag)),void(t.length=e.position-t.dataOffset);t.length=e.byteArray.length-t.dataOffset,e.seek(e.byteArray.length-e.position)}var E=function(e,t){return void 0!==e.vr?"SQ"===e.vr:t.position+4<=t.byteArray.length?(e=h(t),t.seek(-4),"xfffee000"===e||"xfffee0dd"===e):(t.warnings.push("eof encountered before finding sequence item tag or sequence delimiter tag in peeking to determine VR"),!1)};function A(e,t,r){if(void 0===e)throw"dicomParser.readDicomElementImplicit: missing required parameter 'byteStream'";var a;return 4294967295===(a={tag:a=h(e),vr:void 0!==r?r(a):void 0,length:e.readUint32(),dataOffset:e.position}).length&&(a.hadUndefinedLength=!0),a.tag===t||(!E(a,e)||i(a.tag)&&!a.hadUndefinedLength?a.hadUndefinedLength?x(e,a):e.seek(a.length):(D(e,a,r),i(a.tag)&&(a.items=void 0))),a}function S(e){if(void 0===e)throw"dicomParser.readSequenceItem: missing required parameter 'byteStream'";var t={tag:h(e),length:e.readUint32(),dataOffset:e.position};if("xfffee000"!==t.tag)throw"dicomParser.readSequenceItem: item tag (FFFE,E000) not found at offset ".concat(e.position);return t}function O(e,t){var r=S(e);return 4294967295===r.length?(r.hadUndefinedLength=!0,r.dataSet=function(e,t){for(var r={};e.position<e.byteArray.length;){var a=A(e,void 0,t);if("xfffee00d"===(r[a.tag]=a).tag)return new P(e.byteArrayParser,e.byteArray,r)}return e.warnings.push("eof encountered before finding sequence item delimiter in sequence item of undefined length"),new P(e.byteArrayParser,e.byteArray,r)}(e,t),r.length=e.position-r.dataOffset):(r.dataSet=new P(e.byteArrayParser,e.byteArray,{}),k(r.dataSet,e,e.position+r.length,{vrCallback:t})),r}function D(e,t,r){if(void 0===e)throw"dicomParser.readSequenceItemsImplicit: missing required parameter 'byteStream'";if(void 0===t)throw"dicomParser.readSequenceItemsImplicit: missing required parameter 'element'";t.items=[],(4294967295===t.length?function(e,t,r){for(;e.position+4<=e.byteArray.length;){var a=h(e);if(e.seek(-4),"xfffee0dd"===a)return t.length=e.position-t.dataOffset,e.seek(8);a=O(e,r),t.items.push(a)}e.warnings.push("eof encountered before finding sequence delimiter in sequence of undefined length"),t.length=e.byteArray.length-t.dataOffset}:function(e,t,r){for(var a=t.dataOffset+t.length;e.position<a;){var n=O(e,r);t.items.push(n)}})(e,t,r)}function F(e,t){var r=S(e);return 4294967295===r.length?(r.hadUndefinedLength=!0,r.dataSet=function(e,t){for(var r={};e.position<e.byteArray.length;){var a=B(e,t);if("xfffee00d"===(r[a.tag]=a).tag)return new P(e.byteArrayParser,e.byteArray,r)}return t.push("eof encountered before finding item delimiter tag while reading sequence item of undefined length"),new P(e.byteArrayParser,e.byteArray,r)}(e,t),r.length=e.position-r.dataOffset):(r.dataSet=new P(e.byteArrayParser,e.byteArray,{}),T(r.dataSet,e,e.position+r.length)),r}function U(e,t,r){if(void 0===e)throw"dicomParser.readSequenceItemsExplicit: missing required parameter 'byteStream'";if(void 0===t)throw"dicomParser.readSequenceItemsExplicit: missing required parameter 'element'";t.items=[],(4294967295===t.length?function(e,t,r){for(;e.position+4<=e.byteArray.length;){var a=h(e);if(e.seek(-4),"xfffee0dd"===a)return t.length=e.position-t.dataOffset,e.seek(8);a=F(e,r),t.items.push(a)}r.push("eof encountered before finding sequence delimitation tag while reading sequence of undefined length"),t.length=e.position-t.dataOffset}:function(e,t,r){for(var a=t.dataOffset+t.length;e.position<a;){var n=F(e,r);t.items.push(n)}})(e,t,r)}var I=function(e){return"OB"===e||"OD"===e||"OL"===e||"OW"===e||"SQ"===e||"OF"===e||"UC"===e||"UR"===e||"UT"===e||"UN"===e?4:2};function B(e,t,r){if(void 0===e)throw"dicomParser.readDicomElementExplicit: missing required parameter 'byteStream'";var a={tag:h(e),vr:e.readFixedString(2)};return 2===I(a.vr)?a.length=e.readUint16():(e.seek(2),a.length=e.readUint32()),a.dataOffset=e.position,4294967295===a.length&&(a.hadUndefinedLength=!0),a.tag===r||("SQ"===a.vr?U(e,a,t):4294967295===a.length?"x7fe00010"===a.tag?g(e,a,t):("UN"===a.vr?D:x)(e,a):e.seek(a.length)),a}function T(e,t,r){var a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};if(r=void 0===r?t.byteArray.length:r,void 0===t)throw"dicomParser.parseDicomDataSetExplicit: missing required parameter 'byteStream'";if(r<t.position||r>t.byteArray.length)throw"dicomParser.parseDicomDataSetExplicit: invalid value for parameter 'maxP osition'";for(var n=e.elements;t.position<r;){var i=B(t,e.warnings,a.untilTag);if((n[i.tag]=i).tag===a.untilTag)return}if(t.position>r)throw"dicomParser:parseDicomDataSetExplicit: buffer overrun"}function k(e,t,r){var a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};if(r=void 0===r?e.byteArray.length:r,void 0===t)throw"dicomParser.parseDicomDataSetImplicit: missing required parameter 'byteStream'";if(r<t.position||r>t.byteArray.length)throw"dicomParser.parseDicomDataSetImplicit: invalid value for parameter 'maxPosition'";for(var n=e.elements;t.position<r;){var i=A(t,a.untilTag,a.vrCallback);if((n[i.tag]=i).tag===a.untilTag)return}}function q(e,t){if("undefined"!=typeof Buffer&&e instanceof Buffer)return Buffer.alloc(t);if(e instanceof Uint8Array)return new Uint8Array(t);throw"dicomParser.alloc: unknown type for byteArray"}var _="1.8.12",M={readUint16:function(e,t){if(t<0)throw"bigEndianByteArrayParser.readUint16: position cannot be less than 0";if(t+2>e.length)throw"bigEndianByteArrayParser.readUint16: attempt to read past end of buffer";return(e[t]<<8)+e[t+1]},readInt16:function(e,t){if(t<0)throw"bigEndianByteArrayParser.readInt16: position cannot be less than 0";if(t+2>e.length)throw"bigEndianByteArrayParser.readInt16: attempt to read past end of buffer";return 32768&(t=(e[t]<<8)+e[t+1])?t-65535-1:t},readUint32:function(e,t){if(t<0)throw"bigEndianByteArrayParser.readUint32: position cannot be less than 0";if(t+4>e.length)throw"bigEndianByteArrayParser.readUint32: attempt to read past end of buffer";return 256*(256*(256*e[t]+e[t+1])+e[t+2])+e[t+3]},readInt32:function(e,t){if(t<0)throw"bigEndianByteArrayParser.readInt32: position cannot be less than 0";if(t+4>e.length)throw"bigEndianByteArrayParser.readInt32: attempt to read past end of buffer";return(e[t]<<24)+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3]},readFloat:function(e,t){if(t<0)throw"bigEndianByteArrayParser.readFloat: position cannot be less than 0";if(t+4>e.length)throw"bigEndianByteArrayParser.readFloat: attempt to read past end of buffer";var r=new Uint8Array(4);return r[3]=e[t],r[2]=e[t+1],r[1]=e[t+2],r[0]=e[t+3],new Float32Array(r.buffer)[0]},readDouble:function(e,t){if(t<0)throw"bigEndianByteArrayParser.readDouble: position cannot be less than 0";if(t+8>e.length)throw"bigEndianByteArrayParser.readDouble: attempt to read past end of buffer";var r=new Uint8Array(8);return r[7]=e[t],r[6]=e[t+1],r[5]=e[t+2],r[4]=e[t+3],r[3]=e[t+4],r[2]=e[t+5],r[1]=e[t+6],r[0]=e[t+7],new Float64Array(r.buffer)[0]}};function G(e,t,r){if("undefined"!=typeof Buffer&&e instanceof Buffer)return e.slice(t,t+r);if(e instanceof Uint8Array)return new Uint8Array(e.buffer,e.byteOffset+t,r);throw"dicomParser.from: unknown type for byteArray"}function j(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}var L=function(){function e(t,r,a){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),void 0===t)throw"dicomParser.ByteStream: missing required parameter 'byteArrayParser'";if(void 0===r)throw"dicomParser.ByteStream: missing required parameter 'byteArray'";if(r instanceof Uint8Array==0&&("undefined"==typeof Buffer||r instanceof Buffer==0))throw"dicomParser.ByteStream: parameter byteArray is not of type Uint8Array or Buffer";if(a<0)throw"dicomParser.ByteStream: parameter 'position' cannot be less than 0";if(a>=r.length)throw"dicomParser.ByteStream: parameter 'position' cannot be greater than or equal to 'byteArray' length";this.byteArrayParser=t,this.byteArray=r,this.position=a||0,this.warnings=[]}var t,r;return t=e,(r=[{key:"seek",value:function(e){if(this.position+e<0)throw"dicomParser.ByteStream.prototype.seek: cannot seek to position < 0";this.position+=e}},{key:"readByteStream",value:function(t){if(this.position+t>this.byteArray.length)throw"dicomParser.ByteStream.prototype.readByteStream: readByteStream - buffer overread";var r=G(this.byteArray,this.position,t);return this.position+=t,new e(this.byteArrayParser,r)}},{key:"getSize",value:function(){return this.byteArray.length}},{key:"readUint16",value:function(){var e=this.byteArrayParser.readUint16(this.byteArray,this.position);return this.position+=2,e}},{key:"readUint32",value:function(){var e=this.byteArrayParser.readUint32(this.byteArray,this.position);return this.position+=4,e}},{key:"readFixedString",value:function(e){var t=b(this.byteArray,this.position,e);return this.position+=e,t}}])&&j(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),C={readUint16:function(e,t){if(t<0)throw"littleEndianByteArrayParser.readUint16: position cannot be less than 0";if(t+2>e.length)throw"littleEndianByteArrayParser.readUint16: attempt to read past end of buffer";return e[t]+256*e[t+1]},readInt16:function(e,t){if(t<0)throw"littleEndianByteArrayParser.readInt16: position cannot be less than 0";if(t+2>e.length)throw"littleEndianByteArrayParser.readInt16: attempt to read past end of buffer";return 32768&(t=e[t]+(e[t+1]<<8))?t-65535-1:t},readUint32:function(e,t){if(t<0)throw"littleEndianByteArrayParser.readUint32: position cannot be less than 0";if(t+4>e.length)throw"littleEndianByteArrayParser.readUint32: attempt to read past end of buffer";return e[t]+256*e[t+1]+256*e[t+2]*256+256*e[t+3]*256*256},readInt32:function(e,t){if(t<0)throw"littleEndianByteArrayParser.readInt32: position cannot be less than 0";if(t+4>e.length)throw"littleEndianByteArrayParser.readInt32: attempt to read past end of buffer";return e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24)},readFloat:function(e,t){if(t<0)throw"littleEndianByteArrayParser.readFloat: position cannot be less than 0";if(t+4>e.length)throw"littleEndianByteArrayParser.readFloat: attempt to read past end of buffer";var r=new Uint8Array(4);return r[0]=e[t],r[1]=e[t+1],r[2]=e[t+2],r[3]=e[t+3],new Float32Array(r.buffer)[0]},readDouble:function(e,t){if(t<0)throw"littleEndianByteArrayParser.readDouble: position cannot be less than 0";if(t+8>e.length)throw"littleEndianByteArrayParser.readDouble: attempt to read past end of buffer";var r=new Uint8Array(8);return r[0]=e[t],r[1]=e[t+1],r[2]=e[t+2],r[3]=e[t+3],r[4]=e[t+4],r[5]=e[t+5],r[6]=e[t+6],r[7]=e[t+7],new Float64Array(r.buffer)[0]}};function N(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(void 0===e)throw"dicomParser.readPart10Header: missing required parameter 'byteArray'";var r=t.TransferSyntaxUID,a=new L(C,e);return function(){var e=function(){if(a.getSize()<=132&&r)return!1;if(a.seek(128),"DICM"===a.readFixedString(4))return!0;if(!(t||{}).TransferSyntaxUID)throw"dicomParser.readPart10Header: DICM prefix not found at location 132 - this is not a valid DICOM P10 file.";return a.seek(0),!1}(),n=[],i={};if(!e)return a.position=0,{elements:{x00020010:{tag:"x00020010",vr:"UI",Value:r}},warnings:n};for(;a.position<a.byteArray.length;){var o=a.position,s=B(a,n);if("x0002ffff"<s.tag){a.position=o;break}s.parser=C,i[s.tag]=s}return(e=new P(a.byteArrayParser,a.byteArray,i)).warnings=a.warnings,e.position=a.position,e}()}var R="1.2.840.10008.1.2.2";function z(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(void 0===e)throw new Error("dicomParser.parseDicom: missing required parameter 'byteArray'");var a,n=function(t){if(void 0===t.elements.x00020010)throw new Error("dicomParser.parseDicom: missing required meta header attribute 0002,0010");return(t=t.elements.x00020010)&&t.Value||b(e,t.dataOffset,t.length)};function i(a){var i="1.2.840.10008.1.2"!==(o=n(a)),o=function(a,n){var i="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);if("1.2.840.10008.1.2.1.99"!==a)return new L(a===R?M:C,e,n);if(t&&t.inflater)return a=t.inflater(e,n),new L(C,a,0);if(1==i){var o=r(0),s=G(e,n,e.length-n);return o=o.inflateRawSync(s),s=q(e,o.length+n),e.copy(s,0,0,n),o.copy(s,n),new L(C,s,0)}if("undefined"==typeof pako)throw"dicomParser.parseDicom: no inflater available to handle deflate transfer syntax";return o=e.slice(n),s=pako.inflateRaw(o),(o=q(e,s.length+n)).set(e.slice(0,n),0),o.set(s,n),new L(C,o,0)}(o,a.position);(a=new P(o.byteArrayParser,o.byteArray,{})).warnings=o.warnings;try{(i?T:k)(a,o,o.byteArray.length,t)}catch(o){throw{exception:o,dataSet:a}}return a}return function(e,t){for(var r in e.elements)e.elements.hasOwnProperty(r)&&(t.elements[r]=e.elements[r]);return void 0!==e.warnings&&(t.warnings=e.warnings.concat(t.warnings)),t}(a=N(e,t),i(a))}var V=function(e,t,r){for(var a=0,n=t;n<t+r;n++)a+=e[n].length;return a};function J(e,t,r,a,n){if(n=n||t.fragments,void 0===e)throw"dicomParser.readEncapsulatedPixelDataFromFragments: missing required parameter 'dataSet'";if(void 0===t)throw"dicomParser.readEncapsulatedPixelDataFromFragments: missing required parameter 'pixelDataElement'";if(void 0===r)throw"dicomParser.readEncapsulatedPixelDataFromFragments: missing required parameter 'startFragmentIndex'";if(void 0===(a=a||1))throw"dicomParser.readEncapsulatedPixelDataFromFragments: missing required parameter 'numFragments'";if("x7fe00010"!==t.tag)throw"dicomParser.readEncapsulatedPixelDataFromFragments: parameter 'pixelDataElement' refers to non pixel data tag (expected tag = x7fe00010";if(!0!==t.encapsulatedPixelData)throw"dicomParser.readEncapsulatedPixelDataFromFragments: parameter 'pixelDataElement' refers to pixel data element that does not have encapsulated pixel data";if(!0!==t.hadUndefinedLength)throw"dicomParser.readEncapsulatedPixelDataFromFragments: parameter 'pixelDataElement' refers to pixel data element that does not have encapsulated pixel data";if(void 0===t.basicOffsetTable)throw"dicomParser.readEncapsulatedPixelDataFromFragments: parameter 'pixelDataElement' refers to pixel data element that does not have encapsulated pixel data";if(void 0===t.fragments)throw"dicomParser.readEncapsulatedPixelDataFromFragments: parameter 'pixelDataElement' refers to pixel data element that does not have encapsulated pixel data";if(t.fragments.length<=0)throw"dicomParser.readEncapsulatedPixelDataFromFragments: parameter 'pixelDataElement' refers to pixel data element that does not have encapsulated pixel data";if(r<0)throw"dicomParser.readEncapsulatedPixelDataFromFragments: parameter 'startFragmentIndex' must be >= 0";if(r>=t.fragments.length)throw"dicomParser.readEncapsulatedPixelDataFromFragments: parameter 'startFragmentIndex' must be < number of fragments";if(a<1)throw"dicomParser.readEncapsulatedPixelDataFromFragments: parameter 'numFragments' must be > 0";if(r+a>t.fragments.length)throw"dicomParser.readEncapsulatedPixelDataFromFragments: parameter 'startFragment' + 'numFragments' < number of fragments";var i=new L(e.byteArrayParser,e.byteArray,t.dataOffset);if("xfffee000"!==(t=S(i)).tag)throw"dicomParser.readEncapsulatedPixelData: missing basic offset table xfffee000";i.seek(t.length);var o=i.position;if(1===a)return G(i.byteArray,o+n[r].offset+8,n[r].length);t=V(n,r,a);for(var s=q(i.byteArray,t),f=0,d=r;d<r+a;d++)for(var l=o+n[d].offset+8,u=0;u<n[d].length;u++)s[f++]=i.byteArray[l++];return s}var H=function(e,t){for(var r=0;r<e.length;r++)if(e[r].offset===t)return r},W=function(e,t,r,a){if(e===t.length-1)return r.length-a;for(var n=t[e+1],i=a+1;i<r.length;i++)if(r[i].offset===n)return i-a;throw"dicomParser.calculateNumberOfFragmentsForFrame: could not find fragment with offset matching basic offset table"};function Y(e,t,r,a,n){if(a=a||t.basicOffsetTable,n=n||t.fragments,void 0===e)throw"dicomParser.readEncapsulatedImageFrame: missing required parameter 'dataSet'";if(void 0===t)throw"dicomParser.readEncapsulatedImageFrame: missing required parameter 'pixelDataElement'";if(void 0===r)throw"dicomParser.readEncapsulatedImageFrame: missing required parameter 'frameIndex'";if(void 0===a)throw"dicomParser.readEncapsulatedImageFrame: parameter 'pixelDataElement' does not have basicOffsetTable";if("x7fe00010"!==t.tag)throw"dicomParser.readEncapsulatedImageFrame: parameter 'pixelDataElement' refers to non pixel data tag (expected tag = x7fe00010)";if(!0!==t.encapsulatedPixelData)throw"dicomParser.readEncapsulatedImageFrame: parameter 'pixelDataElement' refers to pixel data element that does not have encapsulated pixel data";if(!0!==t.hadUndefinedLength)throw"dicomParser.readEncapsulatedImageFrame: parameter 'pixelDataElement' refers to pixel data element that does not have undefined length";if(void 0===t.fragments)throw"dicomParser.readEncapsulatedImageFrame: parameter 'pixelDataElement' refers to pixel data element that does not have fragments";if(0===a.length)throw"dicomParser.readEncapsulatedImageFrame: basicOffsetTable has zero entries";if(r<0)throw"dicomParser.readEncapsulatedImageFrame: parameter 'frameIndex' must be >= 0";if(r>=a.length)throw"dicomParser.readEncapsulatedImageFrame: parameter 'frameIndex' must be < basicOffsetTable.length";var i=a[r];if(void 0===(i=H(n,i)))throw"dicomParser.readEncapsulatedImageFrame: unable to find fragment that matches basic offset table entry";return J(e,t,i,W(r,a,n,i),n)}var Q=!1;function $(e,t,r){if(Q||(Q=!0,console&&console.log&&console.log("WARNING: dicomParser.readEncapsulatedPixelData() has been deprecated")),void 0===e)throw"dicomParser.readEncapsulatedPixelData: missing required parameter 'dataSet'";if(void 0===t)throw"dicomParser.readEncapsulatedPixelData: missing required parameter 'element'";if(void 0===r)throw"dicomParser.readEncapsulatedPixelData: missing required parameter 'frame'";if("x7fe00010"!==t.tag)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to non pixel data tag (expected tag = x7fe00010)";if(!0!==t.encapsulatedPixelData)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(!0!==t.hadUndefinedLength)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(void 0===t.basicOffsetTable)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(void 0===t.fragments)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(r<0)throw"dicomParser.readEncapsulatedPixelData: parameter 'frame' must be >= 0";return 0!==t.basicOffsetTable.length?Y(e,t,r):J(e,t,0,t.fragments.length)}t.default={isStringVr:n,isPrivateTag:i,parsePN:o,parseTM:s,parseDA:d,explicitElementToString:l,explicitDataSetToJS:u,createJPEGBasicOffsetTable:m,parseDicomDataSetExplicit:T,parseDicomDataSetImplicit:k,readFixedString:b,alloc:q,version:_,bigEndianByteArrayParser:M,ByteStream:L,sharedCopy:G,DataSet:P,findAndSetUNElementLength:y,findEndOfEncapsulatedElement:g,findItemDelimitationItemAndSetElementLength:x,littleEndianByteArrayParser:C,parseDicom:z,readDicomElementExplicit:B,readDicomElementImplicit:A,readEncapsulatedImageFrame:Y,readEncapsulatedPixelData:$,readEncapsulatedPixelDataFromFragments:J,readPart10Header:N,readSequenceItemsExplicit:U,readSequenceItemsImplicit:D,readSequenceItem:S,readTag:h,LEI:"1.2.840.10008.1.2",LEE:"1.2.840.10008.1.2.1"}}],a={},t.m=r,t.c=a,t.d=function(e,r,a){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:a})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(t.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var n in e)t.d(a,n,function(t){return e[t]}.bind(null,n));return a},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1);function t(e){if(a[e])return a[e].exports;var n=a[e]={i:e,l:!1,exports:{}};return r[e].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r,a}(b)}(y)),y.exports),w=m(v),P=function(){return o(function e(t){n(this,e),s(this,"cache",void 0),s(this,"max",void 0),this.max=t,this.cache=new Map},[{key:"get",value:function(e){var t=this.cache.get(e);return t&&(this.cache.delete(e),this.cache.set(e,t)),t}},{key:"set",value:function(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size===this.max){var r=this.cache.keys().next().value;void 0!==r&&this.cache.delete(r)}this.cache.set(e,t)}}])}(),x=function(){return o(function e(){n(this,e)},[{key:"initialize",value:function(e){throw new Error("initialize should be implemented")}},{key:"render",value:function(){var e=r(l().m(function e(t,r){return l().w(function(e){for(;;)switch(e.n){case 0:throw new Error("render should be implemented");case 1:return e.a(2)}},e)}));return function(t,r){return e.apply(this,arguments)}}()}],[{key:"create",value:function(e,t){if(!t.photometricInterpretation)throw new Error("Photometric interpretation is required to construct a rendering pipeline");var r=this.pipelineCache.get(t.photometricInterpretation);if(void 0!==r)return r;if("MONOCHROME1"===t.photometricInterpretation||"MONOCHROME2"===t.photometricInterpretation){var a=new E;return a.initialize(e),this.pipelineCache.set(t.photometricInterpretation,a),a}throw new Error("Unsupported photometric interpretation: ".concat(t.photometricInterpretation))}}])}();s(x,"pipelineCache",new P(5));var E=function(e){function t(){var e;n(this,t);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return s(e=a(this,t,[].concat(i)),"device",void 0),s(e,"computePipeline",void 0),s(e,"bindGroupLayout",void 0),e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}(t,e),o(t,[{key:"initialize",value:function(e){var t=e.createShaderModule({label:"Grayscale shader module",code:"\nstruct ImageFrame {\n  size: vec2<u32>, // x: columns, y: rows\n  scale: vec2<f32>, // x: slope, y: intercept\n  window: vec2<f32>, // x: center, y: width\n  minMax: vec2<f32>, // x: min, y: max\n  pixelData: array<f32>\n}\n\n@group(0) @binding(0) var<storage, read> imageFrame: ImageFrame;\n@group(0) @binding(1) var<storage, read_write> renderedPixelData: array<f32>;\n\n@compute @workgroup_size(8, 8)\nfn main(\n  @builtin(global_invocation_id) global_id: vec3<u32>\n){\n  if(global_id.x > imageFrame.size.x || global_id.y > imageFrame.size.y) {\n    return;\n  }\n\n  let idx = (imageFrame.size.x * global_id.y) + global_id.x;\n  let p = imageFrame.pixelData[idx];\n  \n  // Rescale LUT\n  let s = p * imageFrame.scale.x + imageFrame.scale.y;\n\n  // VOI LUT\n  let centerMin05 = imageFrame.window.x - 0.5;\n  let widthMin1 = imageFrame.window.y - 1.0;\n  let widthDiv2 = widthMin1 / 2.0;\n  let v = (((s - centerMin05) / widthMin1 + 0.5) * 255.0);\n  \n  let c = clamp(v, 0.0, 255.0);\n\n  renderedPixelData[idx] = c;\n}\n"}),r=e.createBindGroupLayout({label:"Grayscale bind group layout",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),a=e.createPipelineLayout({bindGroupLayouts:[r]}),n=e.createComputePipeline({label:"Grayscale compute pipeline",layout:a,compute:{module:t,entryPoint:"main"}});this.device=e,this.bindGroupLayout=r,this.computePipeline=n}},{key:"render",value:(i=r(l().m(function e(t,r){var a,n,i,o,s,f,d,u,c,p,m,h,g,y,b,v,w,P,x,E,A,S,O,D,F,U,I,B;return l().w(function(e){for(;;)switch(e.n){case 0:if(void 0!==this.device&&void 0!==this.computePipeline&&void 0!==this.bindGroupLayout){e.n=1;break}throw new Error("Pipeline is not initialized");case 1:return a=t.rows,n=t.columns,i=t.rescaleSlope,o=t.rescaleIntercept,s=t.windowCenter,f=t.windowWidth,d=t.pixelData,u=t.minPixelValue,c=t.maxPixelValue,p=t.photometricInterpretation,m="MONOCHROME1"===p,g=32+(h=a*n*4),y=16*Math.ceil(g/16),b=this.device.createBuffer({label:"Image frame buffer input",size:y,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),v=this.device.createBuffer({label:"Pixel data buffer output",size:g,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),w=this.device.createBuffer({label:"Pixel data staging buffer",size:h,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),P=this.device.createBindGroup({label:"Grayscale bind group",layout:this.bindGroupLayout,entries:[{binding:0,resource:{buffer:b}},{binding:1,resource:{buffer:v}}]}),this.device.queue.writeBuffer(b,0,new Int32Array([n,a])),this.device.queue.writeBuffer(b,8,new Float32Array([i,o])),this.device.queue.writeBuffer(b,16,new Float32Array([s,f])),this.device.queue.writeBuffer(b,24,new Float32Array([u,c])),x=d,(E=new Float32Array(x.length)).set(x),this.device.queue.writeBuffer(b,32,E),A=this.device.createCommandEncoder({label:"Grayscale encoder"}),(S=A.beginComputePass({label:"Grayscale compute pass"})).setPipeline(this.computePipeline),S.setBindGroup(0,P),S.dispatchWorkgroups(Math.ceil(n/8),Math.ceil(a/8)),S.end(),A.copyBufferToBuffer(v,0,w,0,h),O=A.finish(),this.device.queue.submit([O]),e.n=2,w.mapAsync(GPUMapMode.READ,0,h);case 2:for(D=new Float32Array(w.getMappedRange(0,h).slice()),w.unmap(),b.destroy(),v.destroy(),F=new Uint8Array(4*a*n),U=0,I=0;U<a*n;U++)B=m?255-Math.trunc(D[U]):Math.trunc(D[U]),F[I++]=B,F[I++]=B,F[I++]=B,F[I++]=255;return e.a(2,{pixelData:F,width:n,height:a})}},e,this)})),function(e,t){return i.apply(this,arguments)})}]);var i}(x);function A(e,t,r,a,n){var i;if(8===a&&7===n&&8===r)i=e;else{if(!(r<=16))throw new Error("Unsupported pixel data value for bits stored: ".concat(a));if(0===t)i=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/Uint16Array.BYTES_PER_ELEMENT);else{var o=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/Uint16Array.BYTES_PER_ELEMENT);i=new Int16Array(o)}}return i}function S(e,t,r){if(!e)throw new Error("Dataset is required");var a=e.string(t);if(a){var n=a.split("\\");if(!(n.length<r))return n.map(function(e){return parseFloat(e)})}}function O(e){for(var t=e[0],r=t,a=0;a<e.length;a++){var n=e[a];n<t?t=n:n>r&&(r=n)}return{minPixelValue:t,maxPixelValue:r}}function D(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=e.elements.x7fe00010||e.elements.x7fe00008;if(!r)throw new Error("Pixel data element was not found");if(r.encapsulatedPixelData)throw new Error("Encapsulated pixel data is not supported");return function(e,t){var r=e.elements.x7fe00010||e.elements.x7fe00008,a=e.uint16("x00280100"),n=e.uint16("x00280010"),i=e.uint16("x00280011"),o=e.uint16("x00280002");if(!r)throw new Error("Pixel data element is missing");if(!(a&&n&&i&&o))throw new Error("Missing required attributes [allocated: ".concat(a,", rows: ").concat(n,", columns: ").concat(i,", samples: ").concat(o,"]"));var s=r.dataOffset,f=n*i*o;if(8===a){var d=s+t*f;if(d>=e.byteArray.length)throw new Error("Frame exceeds size of pixel data");return new Uint8Array(e.byteArray.buffer.slice(d,d+f))}if(16===a){var l=s+t*f*2;if(l>=e.byteArray.length)throw new Error("Frame exceeds size of pixel data");return new Uint8Array(e.byteArray.buffer.slice(l,l+2*f))}throw new Error("Unsupported pixel format [Bits allocated: ".concat(a,"]"))}(e,t)}function F(){return(F=r(l().m(function e(t,r,a){var n,i,o,s,f,d,u,c,p,m,h,g,y,b,v,P,E,F,U,I,B,T,k;return l().w(function(e){for(;;)switch(e.n){case 0:if(t){e.n=1;break}throw new Error("GPU device is required");case 1:if(r){e.n=2;break}throw new Error("DICOM data buffer is required");case 2:if(a=a||{},n=w.parseDicom(r)){e.n=3;break}throw new Error("Failed to parse DICOM data");case 3:if(n.string("x00020010")){e.n=4;break}throw new Error("Transfer syntax UID is missing");case 4:if(i=D(n,a.frameIndex||0)){e.n=5;break}throw new Error("Pixel data is missing");case 5:if(o=n.uint16("x00280010"),s=n.uint16("x00280011"),o&&s){e.n=6;break}throw new Error("Rows and columns are required");case 6:if(f=n.uint16("x00280103")||0,d=n.uint16("x00280100")||0,u=n.uint16("x00280101")||d,c=n.uint16("x00280102")||u-1,8===d||16===d){e.n=7;break}throw new Error("Invalid bits allocated value [bits: ".concat(d,"]"));case 7:return p=A(i,f,d,u,c),m=O(p),h=m.minPixelValue,g=m.maxPixelValue,y=n.floatString("x00281052")||0,b=n.floatString("x00281053")||1,v=S(n,"x00281050",1),P=Array.isArray(v)?v[0]:v,E=S(n,"x00281051",1),F=Array.isArray(E)?E[0]:E,void 0!==P&&void 0!==F||(F=(U=g*b+y)-(I=h*b+y),P=(U+I)/2),B={samplesPerPixel:n.uint16("x00280002")||1,photometricInterpretation:n.string("x00280004")||"",planarConfiguration:n.uint16("x00280006")||0,rows:o,columns:s,bitsAllocated:d,bitsStored:u,highBit:c,rescaleIntercept:y,rescaleSlope:b,pixelRepresentation:f,minPixelValue:h,maxPixelValue:g,windowCenter:P,windowWidth:F,pixelData:p},T=x.create(t,B),e.n=8,T.render(B,a);case 8:return k=e.v,e.a(2,k)}},e)}))).apply(this,arguments)}e.render=function(e,t,r){return F.apply(this,arguments)}});
//# sourceMappingURL=dicom-imaging-webgpu.js.map
