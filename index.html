<!doctype html>
<html lang="en">
  <head>
    <title>dicom-imaging-webgpu rendering example</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"
    />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        display: table;
      }
      .container {
        display: table-cell;
        text-align: center;
        vertical-align: middle;
      }
      .content {
        display: inline-block;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="dropZone" class="container">
      <div class="content">
        <p id="infoText">
          Drag and drop a DICOM Part 10 file to render it!<br />Nothing gets uploaded anywhere.
        </p>
        <canvas id="renderingCanvas"></canvas>
      </div>
    </div>
  </body>
  <script type="text/javascript" src="https://unpkg.com/dicom-parser"></script>
  <script type="text/javascript" src="dicom-imaging-webgpu.js"></script>
  <script>
    let webGpuAdapter;
    let webGpuDevice;

    window.onload = async (event) => {
      if (navigator.gpu) {
        webGpuAdapter = await navigator.gpu.requestAdapter();
        webGpuDevice = await webGpuAdapter.requestDevice();
      }
    };

    const { render } = window.dicomImagingWebGpu;

    function renderFile(file) {
      const reader = new FileReader();
      reader.onload = async (file) => {
        const arrayBuffer = reader.result;
        const canvasElement = document.getElementById('renderingCanvas');
        canvasElement.width = 0;
        canvasElement.height = 0;

        const infoTextElement = document.getElementById('infoText');
        infoTextElement.innerText = '';

        try {
          const t0 = performance.now();
          const renderingResult = await render(webGpuDevice, new Uint8Array(arrayBuffer));
          const t1 = performance.now();
          console.log(`Parsing and rendering time: ${t1 - t0} ms`);

          renderFrameCanvas(renderingResult, canvasElement);
        } catch (err) {
          infoTextElement.innerText = 'Error: ' + err.message;
          throw err;
        }
      };
      if (file) {
        reader.readAsArrayBuffer(file);
      }
    }

    function renderFrameCanvas(renderingResult, canvasElement) {
      const renderedPixels = new Uint8Array(renderingResult.pixelData);
      canvasElement.width = renderingResult.width;
      canvasElement.height = renderingResult.height;

      const ctx = canvasElement.getContext('2d');
      ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      const imageData = ctx.createImageData(renderingResult.width, renderingResult.height);
      const canvasPixels = imageData.data;
      for (let i = 0; i < 4 * renderingResult.width * renderingResult.height; i++) {
        canvasPixels[i] = renderedPixels[i];
      }
      ctx.putImageData(imageData, 0, 0);
    }

    const dropZone = document.getElementById('dropZone');
    dropZone.ondragover = (event) => {
      event.stopPropagation();
      event.preventDefault();
      event.dataTransfer.dropEffect = 'copy';
    };
    dropZone.ondrop = (event) => {
      event.stopPropagation();
      event.preventDefault();
      const files = event.dataTransfer.files;
      renderFile(files[0]);
    };
  </script>
</html>
